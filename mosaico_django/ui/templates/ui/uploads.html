{% extends 'ui/base.html' %}

{% block content %}
<div class="mb-4">
  <h1 class="h2 fw-semibold mb-1">Storico caricamenti</h1>
  <p class="text-muted mb-0">Filtra per utente o collection per consultare gli upload effettuati.</p>
</div>

<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label for="usernameInput" class="form-label fw-semibold">Utente</label>
        <input type="text" id="usernameInput" class="form-control" value="{{ request.user.username }}" readonly>
      </div>
      <div class="col-md-3">
        <label for="collectionInput" class="form-label fw-semibold">Collection</label>
        <input type="text" id="collectionInput" class="form-control" placeholder="es. project_alpha">
      </div>
      <div class="col-md-2">
        <label for="limitInput" class="form-label fw-semibold">Limite</label>
        <input type="number" id="limitInput" class="form-control" value="25" min="1" max="500">
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary w-100" id="loadBtn">
          <span id="loadSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
          <i class="bi bi-list-ul me-1"></i>Carica elenco
        </button>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm border-0">
  <div class="card-body">
    <div id="uploadsError"></div>
    <div id="uploadsSummary" class="text-muted small mb-2"></div>
    <div class="table-responsive d-none" id="uploadsTableWrap">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Utente</th>
            <th>Collection</th>
            <th>File originale</th>
            <th>Stato</th>
            <th>Chunks</th>
            <th>Creato il</th>
          </tr>
        </thead>
        <tbody id="uploadsTbody"></tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const JWT_TOKEN = "{{ request.session.jwt_token|default:'' }}";
const FALLBACK_TOKEN = "{{ fake_token }}";
const API_TOKEN = JWT_TOKEN || FALLBACK_TOKEN;
const API_BASE = "{{ api_base }}";

const usernameInput = document.getElementById('usernameInput');
const collectionInput = document.getElementById('collectionInput');
const limitInput = document.getElementById('limitInput');
const loadBtn = document.getElementById('loadBtn');
const loadSpinner = document.getElementById('loadSpinner');
const uploadsError = document.getElementById('uploadsError');
const uploadsSummary = document.getElementById('uploadsSummary');
const uploadsTableWrap = document.getElementById('uploadsTableWrap');
const uploadsTbody = document.getElementById('uploadsTbody');

function buildCollectionName(username, suffix) {
  const cleanSuffix = (suffix || '').trim();
  if (!cleanSuffix) return '';
  if (!username) return cleanSuffix;
  const normalizedUser = username.trim();
  return cleanSuffix.startsWith(`${normalizedUser}_`) ? cleanSuffix : `${normalizedUser}_${cleanSuffix}`;
}

function stripCollectionPrefix(username, collectionName) {
  if (!collectionName) return '';
  if (!username) return collectionName;
  const prefix = `${username.trim()}_`;
  return collectionName.startsWith(prefix) ? collectionName.slice(prefix.length) : collectionName;
}

function formatDate(value) {
  if (!value) return '-';
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return value;
  return date.toLocaleString();
}

function formatStatus(value) {
  if (!value) {
    return '<span class="badge bg-secondary-subtle text-secondary-emphasis">N/D</span>';
  }
  const normalized = String(value).toLowerCase();
  let classes = 'bg-secondary-subtle text-secondary-emphasis';
  if (['done', 'success', 'completed', 'ok'].includes(normalized)) {
    classes = 'bg-success-subtle text-success-emphasis';
  } else if (['processing', 'pending', 'working'].includes(normalized)) {
    classes = 'bg-warning-subtle text-warning-emphasis';
  } else if (['failed', 'error'].includes(normalized)) {
    classes = 'bg-danger-subtle text-danger-emphasis';
  }
  return `<span class="badge ${classes} text-uppercase">${value}</span>`;
}

async function loadUploads() {
  uploadsError.innerHTML = '';
  uploadsSummary.textContent = '';
  uploadsTableWrap.classList.add('d-none');
  uploadsTbody.innerHTML = '';

  const params = new URLSearchParams();
  const username = usernameInput.value.trim();
  if (username) params.append('username', username);
  let normalizedCollection = '';
  if (collectionInput.value) {
    normalizedCollection = buildCollectionName(username, collectionInput.value);
    if (normalizedCollection) params.append('collection', normalizedCollection);
  }
  params.append('limit', limitInput.value || '25');

  loadBtn.disabled = true;
  loadSpinner.classList.remove('d-none');

  try {
    const res = await fetch(`${API_BASE}/uploads?${params.toString()}`, {
      headers: { 'Authorization': `Bearer ${API_TOKEN}` }
    });
    const data = await res.json();
    if (!res.ok) {
      uploadsError.innerHTML = `<div class="alert alert-danger">${data.detail || data.message || 'Errore nella richiesta'}</div>`;
      return;
    }

    const list = Array.isArray(data.uploads) ? data.uploads : [];
    if (!list.length) {
      uploadsSummary.textContent = 'Nessun caricamento trovato per i filtri indicati.';
      return;
    }

    list.forEach((item) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.upload_id || '-'}</td>
        <td>${item.username || '-'}</td>
        <td>${stripCollectionPrefix(item.username, item.collection) || '-'}</td>
        <td>${item.original_filename || item.stored_filename || '-'}</td>
        <td>${formatStatus(item.status)}</td>
        <td>${item.num_chunks ?? '-'}</td>
        <td>${formatDate(item.created_at)}</td>
      `;
      uploadsTbody.appendChild(tr);
    });
    const collectionLabel = normalizedCollection ? stripCollectionPrefix(username, normalizedCollection) : '';
    const summarySuffix = collectionLabel ? ` - Collection: ${collectionLabel}` : '';
    uploadsSummary.textContent = `Totale caricamenti: ${data.count ?? list.length}${summarySuffix}`;
    uploadsTableWrap.classList.remove('d-none');
  } catch (err) {
    console.error(err);
    uploadsError.innerHTML = '<div class="alert alert-danger">Errore di rete durante il caricamento</div>';
  } finally {
    loadSpinner.classList.add('d-none');
    loadBtn.disabled = false;
  }
}

loadBtn.addEventListener('click', loadUploads);

document.addEventListener('DOMContentLoaded', () => {
  const qs = new URLSearchParams(window.location.search);
  const qsCollection = qs.get('collection');
  if (qsCollection) {
    collectionInput.value = stripCollectionPrefix(usernameInput.value.trim(), qsCollection);
  }
  const qsUsername = qs.get('username');
  if (qsUsername) usernameInput.value = qsUsername;
  if (usernameInput.value || collectionInput.value) loadUploads();
});
</script>
{% endblock %}




