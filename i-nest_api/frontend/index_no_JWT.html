<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>INEST API Demo</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container py-4">
  <h1 class="mb-4">Document QA & Chat Demo</h1>

  <!-- Sezione Upload -->
  <div class="card mb-4">
    <div class="card-body">
      <h2 class="card-title h5">1. Carica documento</h2>
      <div class="input-group mb-2">
        <input type="file" class="form-control" id="fileInput">
        <button class="btn btn-primary" id="uploadBtn">
          <span id="uploadSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
          Upload
        </button>
      </div>
      <div id="uploadStatus" class="form-text"></div>
    </div>
  </div>

  <!-- Sezione Chat -->
  <div class="card">
    <div class="card-body">
      <h2 class="card-title h5">2. Chat</h2>
      <div id="chatWindow" class="border rounded p-3 mb-2" style="height: 200px; overflow-y: auto;"></div>
      <div class="input-group">
        <input type="text" class="form-control" id="questionInput" placeholder="Scrivi la tua domanda...">
        <button class="btn btn-success" id="askBtn">
          <span id="askSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
          Invia
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_BASE = 'http://localhost:9000';

// Elementi Upload
const uploadBtn = document.getElementById('uploadBtn');
const uploadSpinner = document.getElementById('uploadSpinner');
const fileInput = document.getElementById('fileInput');
const uploadStatus = document.getElementById('uploadStatus');

uploadBtn.addEventListener('click', async () => {
  if (!fileInput.files.length) return;
  uploadBtn.disabled = true;
  uploadSpinner.classList.remove('d-none');
  uploadStatus.textContent = '';
  uploadStatus.classList.remove('text-success', 'text-danger');

  const form = new FormData();
  form.append('file', fileInput.files[0]);

  try {
    const res = await fetch(`${API_BASE}/upload`, { method: 'POST', body: form });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    uploadStatus.textContent = json.message;
    uploadStatus.classList.add('text-success');
    fileInput.value = '';
  } catch (err) {
    uploadStatus.textContent = 'Errore di upload';
    uploadStatus.classList.add('text-danger');
    console.error(err);
  } finally {
    uploadSpinner.classList.add('d-none');
    uploadBtn.disabled = false;
  }
});

// Elementi Chat
const askBtn = document.getElementById('askBtn');
const askSpinner = document.getElementById('askSpinner');
const questionInput = document.getElementById('questionInput');
const chatWindow = document.getElementById('chatWindow');

askBtn.addEventListener('click', async () => {
  const q = questionInput.value.trim();
  if (!q) return;
  appendMessage('user', q);
  askBtn.disabled = true;
  askSpinner.classList.remove('d-none');
  chatWindow.classList.add('border-warning');

  try {
    const form = new FormData();
    form.append('question', q);
    const res = await fetch(`${API_BASE}/chat`, { method: 'POST', body: form });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    appendMessage('bot', json.message);
  } catch (err) {
    appendMessage('bot', 'Errore nella richiesta');
    console.error(err);
  } finally {
    askSpinner.classList.add('d-none');
    askBtn.disabled = false;
    chatWindow.classList.remove('border-warning');
    questionInput.value = '';
  }
});

function appendMessage(who, text) {
  const el = document.createElement('div');
  const alignClass = who === 'user' ? 'text-end text-primary' : 'text-start text-dark';
  el.className = `mb-2 ${alignClass}`;
  el.textContent = (who === 'user' ? 'Tu: ' : 'Bot: ') + text;
  chatWindow.appendChild(el);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}
</script>
</body>
</html>
